name: Split Build (Smart Cache & Lightweight)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # --- JOB 1: CHỈ XỬ LÝ PYTHON (GIỮ NGUYÊN) ---
  build-python:
    runs-on: windows-latest
    outputs:
      cache-hit: ${{ steps.cache-backend.outputs.cache-hit }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Calculate Backend Hash
        id: backend-hash
        run: echo "hash=${{ hashFiles('backend/**') }}" >> $GITHUB_OUTPUT
        shell: bash

      - name: Cache Python Executable
        id: cache-backend
        uses: actions/cache@v4
        with:
          path: backend/dist/backend.exe
          key: backend-exe-${{ steps.backend-hash.outputs.hash }}

      - name: Set up Python
        if: steps.cache-backend.outputs.cache-hit != 'true'
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Dependencies
        if: steps.cache-backend.outputs.cache-hit != 'true'
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build EXE
        if: steps.cache-backend.outputs.cache-hit != 'true'
        run: |
          cd backend
          pyinstaller --onefile --name backend --clean main.py

      - name: Upload Backend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-binary
          path: backend/dist/backend.exe

  # --- JOB 2: CHỈ XỬ LÝ TAURI & ĐÓNG GÓI GỌN NHẸ ---
  build-tauri:
    needs: build-python
    runs-on: windows-latest
    
    steps:
      - uses: actions/checkout@v4

      # 1. Tải Backend về
      - name: Download Backend Artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-binary
          path: backend/dist

      # 2. Setup Node
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Frontend Deps
        run: |
          cd frontend
          npm install

      # 3. Setup Rust & Cache
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: frontend/src-tauri
          prefix-key: "v2-rust-final-optimized"

      # 4. Chuẩn bị Sidecar
      - name: Prepare Sidecar
        run: |
          mkdir frontend\src-tauri\binaries
          copy backend\dist\backend.exe frontend\src-tauri\binaries\backend-x86_64-pc-windows-msvc.exe

      # 5. Build Tauri
      - name: Build Tauri App
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: "./frontend"
          args: "--target x86_64-pc-windows-msvc"

      # --- 6. ĐÓNG GÓI GỌN NHẸ (LỌC FILE) ---
      # Bước này dùng PowerShell để nhặt đúng file cần thiết
      - name: Package Only Necessary Files
        run: |
          New-Item -ItemType Directory -Force -Path "SecondBrain-Portable"
          
          # Đường dẫn gốc nơi Tauri nhả file
          $BaseDir = "frontend\src-tauri\target\x86_64-pc-windows-msvc\release"
          
          # 1. Copy file chính và đổi tên
          Copy-Item "$BaseDir\frontend.exe" "SecondBrain-Portable\SecondBrain.exe"
          
          # 2. Copy Sidecar (Bắt buộc)
          Copy-Item "$BaseDir\backend-x86_64-pc-windows-msvc.exe" "SecondBrain-Portable\"
          
          # 3. Copy WebView2Loader.dll (Nếu có - để chạy trên máy lạ không lỗi)
          if (Test-Path "$BaseDir\WebView2Loader.dll") {
              Copy-Item "$BaseDir\WebView2Loader.dll" "SecondBrain-Portable\"
          }

      # 7. Upload thành phẩm (Chỉ folder gọn nhẹ)
      - name: Upload Portable Zip
        uses: actions/upload-artifact@v4
        with:
          name: SecondBrain-Portable
          path: SecondBrain-Portable/