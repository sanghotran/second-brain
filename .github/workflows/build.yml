name: Split Build (Smart Cache)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # --- JOB 1: CHỈ XỬ LÝ PYTHON ---
  build-python:
    runs-on: windows-latest
    outputs:
      # Báo hiệu xem có cache hay không (để debug)
      cache-hit: ${{ steps.cache-backend.outputs.cache-hit }}
    
    steps:
      - uses: actions/checkout@v4

      # 1. Tính toán mã băm (Hash) của thư mục backend
      # Nếu bạn không sửa code Python, Hash này sẽ y hệt lần trước
      - name: Calculate Backend Hash
        id: backend-hash
        run: echo "hash=${{ hashFiles('backend/**') }}" >> $GITHUB_OUTPUT
        shell: bash

      # 2. Kiểm tra Cache xem file EXE này đã từng build chưa
      - name: Cache Python Executable
        id: cache-backend
        uses: actions/cache@v4
        with:
          path: backend/dist/backend.exe
          # Key dựa trên Hash của code. Code không đổi -> Key không đổi -> Có Cache
          key: backend-exe-${{ steps.backend-hash.outputs.hash }}

      # 3. Setup Python (CHỈ CHẠY KHI KHÔNG CÓ CACHE)
      - name: Set up Python
        if: steps.cache-backend.outputs.cache-hit != 'true'
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      # 4. Cài thư viện (CHỈ CHẠY KHI KHÔNG CÓ CACHE)
      - name: Install Dependencies
        if: steps.cache-backend.outputs.cache-hit != 'true'
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pyinstaller

      # 5. Build ra EXE (CHỈ CHẠY KHI KHÔNG CÓ CACHE)
      - name: Build EXE
        if: steps.cache-backend.outputs.cache-hit != 'true'
        run: |
          cd backend
          pyinstaller --onefile --name backend --clean main.py

      # 6. Upload file EXE để chuyển sang Job sau
      - name: Upload Backend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-binary
          path: backend/dist/backend.exe

  # --- JOB 2: CHỈ XỬ LÝ TAURI (FRONTEND) ---
  build-tauri:
    needs: build-python # Bắt buộc chờ Job Python xong mới chạy
    runs-on: windows-latest
    
    steps:
      - uses: actions/checkout@v4

      # 1. Tải file EXE từ Job trước (Hoặc từ Cache của Job trước)
      - name: Download Backend Artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-binary
          path: backend/dist

      # 2. Setup Node (Có cache npm)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Frontend Deps
        run: |
          cd frontend
          npm install

      # 3. Setup Rust (Có cache biên dịch - Quan trọng nhất để nhanh)
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: frontend/src-tauri
          prefix-key: "v2-rust-final"

      # 4. Chuẩn bị Sidecar
      - name: Prepare Sidecar
        run: |
          mkdir frontend\src-tauri\binaries
          copy backend\dist\backend.exe frontend\src-tauri\binaries\backend-x86_64-pc-windows-msvc.exe

      # 5. Build Tauri
      - name: Build Tauri App
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: "./frontend"
          args: "--target x86_64-pc-windows-msvc"

      # 6. Upload kết quả cuối cùng
      - name: Upload Final App
        uses: actions/upload-artifact@v4
        with:
          name: SecondBrain-App
          path: frontend/src-tauri/target/x86_64-pc-windows-msvc/release/